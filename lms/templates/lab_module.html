% if errors:
  <div>${errors}</div>
% else:

  <style>
    #course-content {
      background-image: url('https://labsterim.s3.amazonaws.com/media/uploads/labster/labster2_small.png');
      background-position: bottom -100px right -90px;
      background-repeat: no-repeat;
      padding-right: 270px;
    }
    #missingUnityContainer h2,
    #missingUnityContainer h3,
    #missingUnityContainer h4,
    #missingUnityContainer p,
    #labModuleContainer h2,
    #labModuleContainer p {
      margin-bottom: 16px;
    }
    #unityPlayerContainer {
      background-color: #000;
      position: fixed;
      height: 100%;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 100;
    }
    #unityPlayerContainer .exit-lab {
      background-color: #1D354D;
      border-radius: 3px;
      border: 1px solid #fff;
      color: #fff;
      left: 48px;
      padding: 10px 16px;
      position: fixed;
      top: -1px;
      z-index: 200;
      border-top: none;
    }
    #unityPlayer {
      width: 100%;
      height: 100%;
    }
    #unityPlayer .missing {
      width: inherit;
      height: inherit;
      text-align: center;
      line-height: 650px;
    }
    .download-chrome img {
      height: 24px;
      margin-top: -4px;
      margin-right: 5px;
      margin-left: -4px;
    }
  </style>
  <script type="text/javascript">
  <!--
  var unityObjectUrl = "http://webplayer.unity3d.com/download_webplayer-3.x/3.0/uo/UnityObject2.js";
  if (document.location.protocol == 'https:')
      unityObjectUrl = unityObjectUrl.replace("http://", "https://ssl-");
  document.write('<script type="text/javascript" src="' + unityObjectUrl + '"></script>');
  -->
  </script>

  <!--
  <h4>${lab.name}</h4>
  <div>${lab.description}</div>

  <hr>
  <div>token: ${user_token.key}</div>
  <div>lab_id: ${lab_proxy.id}</div>
  <hr>
  <div>user_id: ${module.scope_ids.user_id}</div>
  <div>${module.location}</div>
  <div>${lab.name}</div>
  -->

  <div class="loading">Loading &hellip;</div>
  <div id="missingUnityContainer" style="display:none">
    <h2>${lab.name}</h2>
    <h3>How to Play Our Labs</h3>
    <p>To help you get started using our labs for the first time, please read through these quick guides below. If you have already used our labs in the past, you can skip these steps, and go directly to the next section.</p>
    <div class="browser ie opera" style="display:none">
      <h3>Please Use Modern Browser</h3>
      <p>For Labster's virtual labs we recommend using modern browsers like Chrome, Firefox or Safari, as the experience is much better with these browser.</p>
      <p>Therefore, if you already have installed one of the browsers above, please launch the browser, and login again to this course from that browser.</p>
      <p>If you do not have one of these browsers above, please download Google Chrome using the button below, and then login to Labster again, with the new browser.</p>
      <p><a target="_blank" href="https://google.com/chrome/browser/" class="button-labster-blue download-chrome">
        <span><img src="https://labsterim.s3.amazonaws.com/media/uploads/edx/chrome_0.png"></span>
        Download Google Chrome</a></p>
    </div>
    <div class="browser chrome firefox safari" style="display:none">
      <h3>Unity3D Player</h3>
      <p>You may also need to install the Unity Player plugin in the browser in order to play Labster. This will only happen the first time you try one of our labs, and to help guide you through the process, please have a quick look at the video below.</p>
      <h4>Run Blocked Plug-ins</h4>
      <p>You can run some plug-ins even if they are blocked by Chrome. Chrome will ask you for permission to run a plug-in and you should only run plug-ins on sites that you trust.</p>
      <p>To let the plug-in run on the site, follow these steps:</p>
      <ul>
        <li>To run the plug-in just this once, click Run this time. The plug-in will run, but if you visit the site later, you'll be asked for permission to run the plug-in again.</li>
        <li>To always allow the current site to run the plug-in, click Always run on this site. Subsequent visits to the site will run the plug-in without asking again.</li>
        <li>To always allow this type of plug-in to run, go to chrome://plugins, find the plug-in and check the box next to Always allowed.</li>
      </ul>
      <h3>How to Install Unity Player</h3>
      <p><iframe width="560" height="315" src="//www.youtube.com/embed/7iVtAmiqIaE" frameborder="0" allowfullscreen></iframe></p>
      <h3>Install Unity Player Now</h3>
      <p>Please click the button below, to start the Unity player install.</p>
      <div id="unityPlayerTest">
        <div class="missing">
          <a href="http://unity3d.com/webplayer/" title="Unity Web Player. Install now!">
            <img alt="Unity Web Player. Install now!" src="http://webplayer.unity3d.com/installation/getunity.png" width="193" height="63" />
          </a>
        </div>
      </div>
    </div>
  </div>
  <div id="labModuleContainer" style="display:none">
    <div class="lab-module-info">
      <h2>${lab.name}</h2>
      <p>In this section, you will be using one of the virtual Labster labs.</p>
      % if user_save:
      <p>It appears that you have already used this specific lab in the past, and we have automatically stored your progress in the lab, so you don't have to start all from the beginning.</p>
      <p>Please click the <strong>Continue from save game</strong> button below, if you would like to continue from the last position in the lab that was stored, or click <strong>Restart from beginning</strong> if you would like to play the whole lab from the start again.</p>
      % else:
      <p>Please click the button below, to begin the exercise and enter the virtual lab.</p>
      % endif
    </div>
    <div id="buttonContent">
      % if user_save:
      <a class="button button-labster-grey playLabButton" data-url="start_new_lab/?token=${user_token.key}" id="startNewButton" href="#">Restart from beginning</a>
      <a class="button button-labster-blue playLabButton" data-url="continue_lab/?token=${user_token.key}" id="continueButton" href="#">Continue from save game</a>
      % else:
      <a class="button button-labster-blue playLabButton" data-url="start_new_lab/?token=${user_token.key}" id="startNewButton" href="#">Enter the Lab</a>
      % endif
    </div>

    <div id="unityPlayerContainer" style="display:none">
      <a href="" class="exit-lab labster-blue-button">Exit Lab</a>
      <div id="unityPlayer">
        <div class="missing">
          <a href="http://unity3d.com/webplayer/" title="Unity Web Player. Install now!">
            <img alt="Unity Web Player. Install now!" src="http://webplayer.unity3d.com/installation/getunity.png" width="193" height="63" />
          </a>
        </div>
      </div>
    </div>

  </div>

  <script id="unityPlayerTemplate" type="text/template">
  </script>

  <!-- Segment.IO Start -->
  <script type="text/javascript">
    window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(a){return function(){var t=Array.prototype.slice.call(arguments);return t.unshift(a),window.analytics.push(t),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(a){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+a+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},window.analytics.SNIPPET_VERSION="2.0.6",
    window.analytics.load("wdk8zwr84j"),
    window.analytics.page();
  </script>
  <script type="text/javascript">
    function segmentIOIdentify(id, propertiesString)
    {
      var properties = convertStringToObjectArray(propertiesString);
      analytics.identify(id, properties);
    }
    function segmentIOPushEvent(category)
    {
      analytics.track(category);
    }
    function segmentIOPushEventWithProperties(category, propertiesString)
    {
      var dictionary = convertStringToObjectArray(propertiesString);
      analytics.track(category, dictionary);
    }

    function convertStringToObjectArray(objectString)
    {
      var d = {};

      a = objectString.replace("{","").replace("}","").split(",");
      for (i=0;i<a.length;i++)
        {
          pair = a[i];
          prop = pair.split("=");
          d[prop[0]] = prop[1];
        }

      return d;
    }
  </script>
  <!-- Segment.IO End -->

  <script>

    function detectUnityWebPlayer() {
      var tInstalled = false;
      if (navigator.mimeTypes && navigator.mimeTypes["application/vnd.unity"]){
        if (navigator.mimeTypes["application/vnd.unity"].enabledPlugin &&
            navigator.plugins && navigator.plugins["Unity Player"]) {
          tInstalled = true;
        }
      }
      return tInstalled;
    }

    function setPlayerSize() {
      var player = jQuery('#unityPlayer');
      var max_width = 1170;
      var max_height = 760;
      var browser_width = $(document).width();
      var browser_height = $(document).height();
      var unity_width = '100%';
      var unity_height = '100%';
      var margin_left = 0;
      var margin_top = 0;

      var diff_width = browser_width - max_width;
      var diff_height = browser_height - max_height;

      // width & height are larger than max
      if (diff_width > 0 && diff_height > 0) {
        unity_width = max_width;
        unity_height = max_height;

        margin_top = diff_height / 2;
        margin_left = diff_width / 2;

        unity_width = unity_width + 'px';
        unity_height = unity_height + 'px';
        margin_top = margin_top + 'px';
        margin_left = margin_left + 'px';

      }

      var styles = {
        'width': unity_width,
        'height': unity_height,
        'margin-left': margin_left,
        'margin-top': margin_top
      };

      player.css(styles);
    }


    var loaded = false;
    var hasUnity = detectUnityWebPlayer();

    jQuery(function() {
      var browser = jQuery.browser;
      if (browser.webkit || browser.mozilla) {
        jQuery('.browser.chrome').show();
        jQuery('#course-content').css(
            'background-position', 'top -50px right -90px');
      } else {
        jQuery('.browser.ie').show();
      }

      var resizeProc = undefined;
      jQuery(window).resize(function() {
        if (resizeProc != undefined) {
          clearTimeout(resizeProc);
        }

        resizeProc = setTimeout(function() {
          setPlayerSize();
        }, 500);
      });
 
      jQuery('.playLabButton').click(function(ev) {
        ev.preventDefault();
        var el = jQuery(ev.currentTarget);
        var url = el.data('url');

        jQuery.ajax({
          url: url,
          method: 'GET',
          success: function(response) {
          },
          error: function(response) {
          },
          complete: function(response) {
            jQuery('.loading').hide();
            jQuery('#unityPlayerContainer').show();
            jQuery('#labModuleContainer').show();
            setPlayerSize();
            playLab();
          }
        });
      });

      jQuery('#unityPlayerContainer .exit-lab').click(function(ev) {
        ev.preventDefault();
        var sure = confirm("Are you sure you want to close the lab?");
        if (sure) {
          jQuery('#unityPlayerContainer').hide();
          stopLab();
        }
      });

      if (hasUnity) {
        jQuery('#labModuleContainer').show();
        jQuery('.loading').hide();
      } else {
        jQuery('#missingUnityContainer').show();
        jQuery('.loading').hide();
      }
    });

    var u;
    var playLab = function() {
      if (! loaded) {
        var config = {
          params: {
            backgroundcolor: "000000"
          }
        };
        u = new UnityObject2(config);
        u.initPlugin(jQuery("#unityPlayer")[0], "https://s3-us-west-2.amazonaws.com/labster/unity/${lab.engine_file}?token=${user_token.key}");
        loaded = true;
      }

      jQuery('#livechat-compact-container').hide();

      // jQuery('window').bind('resize', function(event) {
      //   setPlayerSize();
      // });
    };

    var stopLab = function() {
      jQuery('#unityPlayer').empty();
      jQuery('#livechat-compact-container').show();
      loaded = false;

      // jQuery('window').unbind('resize');
    };
  </script>

  <script>
    var messages = []
    function Log(message) {
      console.log(message);
      messages.push(message);
    }

    function gaLogEvent(category, action, label, value, noninteract) {}
  </script>

% endif
